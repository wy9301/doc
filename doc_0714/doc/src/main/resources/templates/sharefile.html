<!doctype html >
<html lang="en" class="no-focus" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
    <title>在线文档管理系统-与我共享</title>
    <meta property="og:type" content="website">
    <meta property="og:url" content="">
    <meta property="og:image" content="">
    <link rel="shortcut icon" th:href="@{/asserts/image/favicons/favicon.png}"/>
    <link rel="icon" type="image/png" sizes="192x192" th:href="@{/asserts/imgage/favicons/favicon-192x192.png}"/>
    <link rel="apple-touch-icon" sizes="180x180" th:href="@{/asserts/image/favicons/apple-touch-icon-180x180.png}"/>
    <!-- Stylesheets -->
    <link rel="stylesheet" th:href="@{/asserts/css/codebase.min.css}">
    <link rel="stylesheet" th:href="@{/asserts/js/plugins/datatables/dataTables.bootstrap4.min.css}">

    <style type="text/css">
        .mycol {
            padding: 0 5px;
        }

        .mytd {
            margin: 0px;
            padding: 0px;
            width: 1px;
        }
    </style>
</head>
<body>
<div id="page-container" class="sidebar-o side-scroll page-header-modern main-content-boxed">
    <!-- Side Overlay-->
    <nav id="sidebar">
        <!-- Sidebar Scroll Container -->
        <div id="sidebar-scroll">
            <!-- Sidebar Content -->
            <div class="sidebar-content">
                <!-- Side Header -->
                <div class="content-header content-header-fullrow px-15">
                    <!-- Mini Mode -->
                    <div class="content-header-section sidebar-mini-visible-b">
                        <!-- Logo -->
                        <span class="content-header-item font-w700 font-size-xl float-left animated fadeIn">
									<span class="text-dual-primary-dark">c</span><span class="text-primary">b</span>
								</span>
                        <!-- END Logo -->
                    </div>
                    <!-- END Mini Mode -->

                    <!-- Normal Mode -->
                    <div class="content-header-section text-center align-parent sidebar-mini-hidden">
                        <!-- Close Sidebar, Visible only on mobile screens -->
                        <!-- Layout API, functionality initialized in Codebase() -> uiApiLayout() -->
                        <button type="button" class="btn btn-circle btn-dual-secondary d-lg-none align-v-r"
                                data-toggle="layout"
                                data-action="sidebar_close">
                            <i class="fa fa-times text-danger"></i>
                        </button>
                        <!-- END Close Sidebar -->

                        <!-- Logo -->
                        <div class="content-header-item">
                            <a class="link-effect font-w700" href="index.html">
                                <i class="si si-fire text-primary"></i>
                                <span class="font-size-xl text-dual-primary-dark">在线文档管理</span><span
                                    class="font-size-xl text-primary">系统</span>
                            </a>
                        </div>
                        <!-- END Logo -->
                    </div>
                    <!-- END Normal Mode -->
                </div>
                <!-- END Side Header -->

                <!-- Side User -->
                <div class="content-side content-side-full content-side-user px-10 align-parent">
                    <!-- Visible only in mini mode -->
                    <div class="sidebar-mini-visible-b align-v animated fadeIn">
                        <img class="img-avatar img-avatar32" src="assets/img/avatars/avatar15.jpg" alt="">
                    </div>
                    <!-- END Visible only in mini mode -->

                    <!-- Visible only in normal mode -->
                    <div class="sidebar-mini-hidden-b text-center">
                        <a class="img-link">
                            <img class="img-avatar img-avatar64" th:src="@{'/asserts/image/'+${user.getHead()}}" alt=""
                                 data-toggle="modal"
                                 data-target="#head-model">
                        </a>
                        <ul class="list-inline mt-10">
                            <li class="list-inline-item">
                                <a class="link-effect text-dual-primary-dark font-size-xs font-w600 text-uppercase"
                                   th:text="${user.getUsername()}"></a>
                                <a class="link-effect text-dual-primary-dark font-size-xs font-w600 text-uppercase"
                                   th:text="${user.getId()}" id="user_id" hidden="hidden"></a>
                            </li>
                            <li class="list-inline-item">
                                <!-- Layout API, functionality initialized in Codebase() -> uiApiLayout() -->
                                <a class="link-effect text-dual-primary-dark" data-toggle="layout"
                                   data-action="sidebar_style_inverse_toggle"
                                   href="javascript:void(0)">
                                    <i class="si si-drop"></i>
                                </a>
                            </li>
                            <li class="list-inline-item">
                                <a class="link-effect text-dual-primary-dark" th:href="@{/user/logout}">
                                    <i class="si si-logout"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                    <!-- END Visible only in normal mode -->
                </div>
                <!-- END Side User -->

                <!-- Side Navigation -->
                <div class="content-side content-side-full">
                    <ul class="nav-main">
                        <li>
                            <a th:href="@{/myfile/list}"><i class="fa fa-files-o"></i><span class="sidebar-mini-hide">全部文件</span></a>
                        </li>
                        <li>
                            <a th:href="@{/myfile/share_list}" class="active"><i class="fa fa-share-alt"></i><span
                                    class="sidebar-mini-hide">与我共享</span></a>
                        </li>
                        <li>
                            <a th:href="@{/myfile/friend_list}"><i class="fa fa-group"></i><span
                                    class="sidebar-mini-hide">常用联系人</span></a>
                        </li>
                        <li>
                            <a th:href="@{/syfile/file_list}"><i class="fa fa-briefcase"></i><span
                                    class="sidebar-mini-hide">公共文档</span></a>
                        </li>
                        <li>
                            <a th:href="@{/myfile/recycle_list}" ><i class="fa fa-trash"></i><span
                                    class="sidebar-mini-hide">回收站</span></a>
                        </li>
                    </ul>
                </div>
                <!-- END Side Navigation -->
            </div>
            <!-- Sidebar Content -->
        </div>
        <!-- END Sidebar Scroll Container -->
    </nav>
    <!-- END Sidebar -->

    <!-- Header -->
    <header id="page-header">
        <!-- Header Content -->
        <div class="content-header">
            <!-- Left Section -->
            <div class="content-header-section">
                <!-- Toggle Sidebar -->
                <!-- Layout API, functionality initialized in Codebase() -> uiApiLayout() -->
                <button type="button" class="btn btn-circle btn-dual-secondary" data-toggle="layout"
                        data-action="sidebar_toggle">
                    <i class="fa fa-navicon"></i>
                </button>
                <!-- END Toggle Sidebar -->

                <!-- Open Search Section -->
                <!-- Layout API, functionality initialized in Codebase() -> uiApiLayout() -->
                <button type="button" class="btn btn-circle btn-dual-secondary" data-toggle="layout"
                        data-action="header_search_on">
                    <i class="fa fa-search"></i>
                </button>
                <!-- END Open Search Section -->

                <!-- Layout Options (used just for demonstration) -->
                <!-- Layout API, functionality initialized in Codebase() -> uiApiLayout() -->
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-circle btn-dual-secondary" id="page-header-options-dropdown"
                            data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                        <i class="fa fa-wrench"></i>
                    </button>
                    <div class="dropdown-menu" aria-labelledby="page-header-options-dropdown">
                        <h6 class="dropdown-header">Header</h6>
                        <button type="button" class="btn btn-sm btn-block btn-alt-secondary" data-toggle="layout"
                                data-action="header_fixed_toggle">Fixed
                            Mode
                        </button>
                        <button type="button" class="btn btn-sm btn-block btn-alt-secondary d-none d-lg-block mb-10"
                                data-toggle="layout"
                                data-action="header_style_classic">Classic Style
                        </button>
                        <div class="d-none d-xl-block">
                            <h6 class="dropdown-header">Main Content</h6>
                            <button type="button" class="btn btn-sm btn-block btn-alt-secondary mb-10"
                                    data-toggle="layout" data-action="content_layout_toggle">Toggle
                                Layout
                            </button>
                        </div>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="be_layout_api.html">
                            <i class="si si-chemistry"></i> All Options (API)
                        </a>
                    </div>
                </div>
                <!-- END Layout Options -->
            </div>
            <!-- END Left Section -->

            <!-- Right Section -->
            <div class="content-header-section">
                <!-- User Dropdown -->
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-rounded btn-dual-secondary" id="page-header-user-dropdown"
                            data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                        <span th:text="${user.username}"></span>
                        <i class="fa fa-angle-down ml-5"></i>
                    </button>
                    <div class="dropdown-menu dropdown-menu-right min-width-150"
                         aria-labelledby="page-header-user-dropdown">
                        <a class="dropdown-item" href="javascript:void(0)"
                           data-action="side_overlay_toggle" data-toggle="modal" data-target="#psw_model">
                            <i class="si si-wrench mr-5"></i> 修改密码
                        </a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" th:href="@{/user/logout}">
                            <i class="si si-logout mr-5"></i> 退出登录
                        </a>
                    </div>
                </div>
            </div>
            <!-- END Right Section -->
        </div>
        <!-- END Header Content -->

        <!-- Header Search -->
        <div id="page-header-search" class="overlay-header">
            <div class="content-header content-header-fullrow">
                <form th:action="@{/myfile/search_share}" method="post">
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <!-- Close Search Section -->
                            <!-- Layout API, functionality initialized in Codebase() -> uiApiLayout() -->
                            <button type="button" class="btn btn-secondary" data-toggle="layout"
                                    data-action="header_search_off">
                                <i class="fa fa-times"></i>
                            </button>
                            <!-- END Close Search Section -->
                        </div>
                        <input type="text" class="form-control" placeholder="请输入文件名" id="sname" name="sname">
                        <div class="input-group-append">
                            <button type="submit" class="btn btn-secondary">
                                <i class="fa fa-search"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <!-- END Header Search -->

        <!-- Header Loader -->
        <!-- Please check out the Activity page under Elements category to see examples of showing/hiding it -->
        <div id="page-header-loader" class="overlay-header bg-primary">
            <div class="content-header content-header-fullrow text-center">
                <div class="content-header-item">
                    <i class="fa fa-sun-o fa-spin text-white"></i>
                </div>
            </div>
        </div>
        <!-- END Header Loader -->
    </header>
    <!-- END Header -->

    <!-- Main Container -->
    <main id="main-container">
        <!-- Page Content -->
        <div class="content">
            <h2 class="content-heading">与我共享</h2>
            <!-- Full Table -->
            <div class="block">
                <div class="block-header block-header-default">
                    <h3 class="block-title">文件列表</h3>
                    <!-- upload Modal -->
                    <div class="modal" id="modal-normal" tabindex="-1" role="dialog" aria-labelledby="modal-normal"
                         aria-hidden="true">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="block block-themed block-transparent mb-0">
                                    <div class="block-header bg-primary-dark">
                                        <h3 class="block-title">提取文档</h3>
                                        <div class="block-options">
                                            <button type="button" class="btn-block-option" data-dismiss="modal"
                                                    aria-label="Close">
                                                <i class="si si-close"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div class="row" style="padding: 30px;">
                                        <div class="col-3">
                                            <label style="text-align: center; verticle-align:middle;display:inline-block;padding-top: 5px;">文档提取码：</label>
                                        </div>
                                        <div class="col-8">
                                            <input type="text" class="form-control" id="fetch_code" name="fetch_code"
                                                   placeholder="请输入文档提取码">
                                        </div>
                                    </div>
                                    <div class="row" style="padding: 30px;display: none">
                                        <span id="fetch_file" style="text-align: center;display:block;"></span>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-alt-secondary" data-dismiss="modal">Close
                                    </button>
                                    <button type="button" class="btn btn-alt-success" onclick="search(this)">
                                        查询
                                    </button>
                                </div>

                            </div>
                        </div>
                    </div>
                    <!-- END upload Modal -->
                    <div class="mycol">
                        <button type="button" class="btn btn-outline-warning mr-5 mb-5" data-toggle="modal"
                                data-target="#modal-normal">
                            <i class="fa fa-key mr-5"></i>提取文档
                        </button>
                    </div>
                    <div class="mycol">
                        <button type="button" class="btn btn-outline-danger mr-5 mb-5" onclick="delbatch()">
                            <i class="fa fa-times mr-5"></i>删除
                        </button>
                    </div>
                </div>

                <div class="block-content">
                    <div class="table-responsive">
                        <table class="table table-striped table-vcenter js-dataTable-full" id="table_file">
                            <thead>
                            <tr>
                                <th></th>
                                <th class="text-center" style="width: 100px;"><i class="si si-user"></i></th>
                                <th hidden="hidden"></th>
                                <th>文件名</th>
                                <th style="width: 15%;">大小</th>
                                <th style="width: 20%;">分享者</th>
                                <th style="width: 20%;">更新时间</th>
                                <th class="text-center" style="width: 100px;">操作</th>
                            </tr>
                            </thead>
                            <tbody>

                            <tr th:each="myfile:${list1}">
                                <td class="mytd">
                                    <div class="col-6">
                                        <label class="css-control css-control-secondary css-checkbox">
                                            <input type="checkbox" class="css-control-input" name="del">
                                            <span class="css-control-indicator"></span>
                                        </label>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <!--<img class="img-avatar img-avatar48" src="assets/img/avatars/avatar13.jpg" alt="">-->
                                    <img style="width:30px;height: 30px"
                                         src="../static/asserts/image/avatars/download.png"
                                         th:src="@{'/asserts/image/avatars/'+${myfile.category}+'.png'}">
                                </td>
                                <td hidden="hidden" th:text="${myfile.id}">文件号</td>
                                <td class="font-w600" th:text="${myfile.name}">文件名</td>
                                <td th:text="${myfile.size}">文件大小</td>
                                <td th:text="${myfile.master}">分享者</td>
                                <td>
                                    <span class="badge badge-info" th:text="${myfile.updatetime}">更新时间</span>
                                </td>
                                <td class="text-center">
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-sm btn-secondary" data-toggle="tooltip"
                                                title="下载" onclick="download(this)">
                                            <i class="si si-cloud-download"></i>
                                        </button>
                                    </div>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- END Full Table -->
        </div>
        <!-- END Page Content -->
        <!--uphead model-->
        <div class="modal" id="head-model" tabindex="-1" role="dialog" aria-labelledby="modal-normal"
             aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <form class="form-horizontal" role="form" method="post" enctype="multipart/form-data">
                        <div class="block block-themed block-transparent mb-0">
                            <div class="block-header bg-primary-dark">
                                <h3 class="block-title">上传头像</h3>
                                <div class="block-options">
                                    <button type="button" class="btn-block-option" data-dismiss="modal"
                                            aria-label="Close" id="close_model">
                                        <i class="si si-close"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="block-content" style="padding-bottom: 10px;">
                                <input type="hidden" name="upid" id="upid" th:value="${user.username}"/>
                                <input type="file" name="uphead" id="uphead"/>
                                <div class="form-group" style="text-align: center;">
                                    <button type="button" class="btn btn-alt-primary form-control" onclick="up_head()">
                                        上传
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!--uphead model end-->
        <!--model-->
        <div class="modal" id="psw_model" tabindex="-1" role="dialog" aria-labelledby="modal-normal"
             aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <form class="form-horizontal" role="form" th:action="@{/admin/adduser}" method="post">
                        <div class="block block-themed block-transparent mb-0">
                            <div class="block-header bg-primary-dark">
                                <h3 class="block-title">修改密码</h3>
                                <div class="block-options">
                                    <button type="button" class="btn-block-option" data-dismiss="modal"
                                            aria-label="Close">
                                        <i class="si si-close"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="block-content" style="padding-bottom: 10px;">
                                <div class="form-group">
                                    <label>原密码：</label>
                                    <input type="password" class="form-control" value="" placeholder="" id="oldName"
                                           name="oldName" required>
                                </div>
                                <div class="form-group">
                                    <label>新密码：</label>
                                    <input type="password" class="form-control" autocomplete="off" value=""
                                           placeholder="密码" id="password" name="password" required>
                                </div>
                                <div class="form-group">
                                    <label>新密码确认：</label>
                                    <input type="password" class="form-control" autocomplete="off" placeholder="确认新密码"
                                           id="confirmpwd" name="confirmpwd" required>
                                </div>
                                <div class="form-group" style="text-align: center;">
                                    <button class="btn btn-primary radius" onClick="ch_psw()" id="submitt"
                                            name="submitt" type="button" value="提交">确认
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!--model end-->
    </main>
    <!-- END Main Container -->

    <!-- Footer -->
    <footer id="page-footer" class="opacity-0">
        <div class="content py-20 font-size-xs clearfix">
            <div class="float-right">
                <i class="fa fa-flag text-pulse"></i>Crafted by 620
            </div>
            <div class="float-left">
                <a class="font-w600">SDUT 620_DOC</a> &copy; <span class="js-year-copy">2020</span>
            </div>
        </div>
    </footer>
    <!-- END Footer -->
</div>
<!-- END Page Container -->

<!-- Codebase Core JS -->
<script th:src="@{/asserts/js/core/jquery.min.js}"></script>
<script th:src="@{/asserts/js/core/bootstrap.bundle.min.js}"></script>
<script th:src="@{/asserts/js/core/jquery.slimscroll.min.js}"></script>
<script th:src="@{/asserts/js/core/jquery.scrollLock.min.js}"></script>
<script th:src="@{/asserts/js/core/jquery.appear.min.js}"></script>
<script th:src="@{/asserts/js/core/jquery.countTo.min.js}"></script>
<script th:src="@{/asserts/js/core/js.cookie.min.js}"></script>
<script th:src="@{/asserts/js/codebase.js}"></script>

<script th:src="@{/asserts/js/plugins/datatables/jquery.dataTables.min.js}"></script>
<script th:src="@{/asserts/js/plugins/datatables/dataTables.bootstrap4.min.js}"></script>

<!-- Page JS Code -->
<script th:src="@{/asserts/js/pages/be_tables_datatables.js}"></script>

<script language="JavaScript">
    var flag = 0;//第一次点击，填写分享码后，查询
    var json_static;

    function search(obj) {
        if (flag == 0) {
            var fetch_file = $("#fetch_file");
            var msg = null;
            var json2 = null;
            $.ajax({
                url: "/doc/gen_code/fetchfile",
                type: "post",
                data: {
                    "code": $("#fetch_code").val()
                },
                success: function (json) {

                    if (typeof json =="string") {
                        alert("分享码不存在或已失效")
                    } else {
                        json_static = json;
                        $("#fetch_code").prop("disabled", true);
                        //json2 = json.parseJSON(); //由JSON字符串转换为JSON对象
                        var msg = " 文件名称:" + json.name + "    文件大小:" + json.size + "    分享者:" + json.master;
                        fetch_file.text(msg);
                        fetch_file.parent().css('display', 'block');
                        $(obj).text("确定添加");
                        flag = 1;
                    }
                }
            });
    }
    else
    {//第二次点击，关闭模态，修改文档可见性，刷新页面
        str = $("#user_id").text();
        $.post("/doc/myfile/share", {
            str: str+",",
            share_col: json_static.id
        }, function () {
            window.location = "/doc/myfile/share_list";
        });
    }

    }

    function ch_psw() {
        var txtconfirm = $.trim($("#confirmpwd").val());
        var txtPwd = $("#password").val();
        if ($.trim(txtconfirm) != $.trim(txtPwd)) {
            alert('你输入的密码不匹配，请从新输入！');
            $("#txtconfirm").focus();
        } else if (txtPwd.length < 6) {
            alert("密码长度需大于等于6位！");
        } else {
            $.ajax({
                type: 'POST',
                url: '/doc/user/change_psw',
                data: {
                    "oldpsw": $("#oldName").val(),
                    "newpsw": txtPwd
                },
                success: function (data) {
                    if (data == "1") {
                        alert("修改成功，请重新登陆");
                        window.location = "/doc/user/index";
                    } else if (data == "0")
                        alert("原密码错误！");
                    $("#oldName").focus();
                },
                error: function () {
                    alert("网络错误，修改失败");
                },
            });
        }
    }

    function up_head() {
        var formData = new FormData();
        formData.append('file', $('#uphead')[0].files[0]);  //添加图片信息的参数
        var upid = $('#upid').text();
        $.ajax({
            url: "/doc/user/uphead",
            type: "post",
            data: /*formData,*/formData,
            processData: false, //因为data值是FormData对象，不需要对数据做处理。
            contentType: false,
            success: function (msg) {
                alert(msg);
                window.location = "/doc/myfile/share_list";
            }
        });
    }

    function download(obj) {
        var idd = $(obj).parent().parent().parent().find("td").eq(2).text(); //获取当前行的id
        url = "/doc/myfile/download?id=" + idd;
        window.open(url);
    }

    function delbatch() {
        var st = "";
        var checkData = new Array();
        var delSize = $("[name=del]:checked").length;//通过筛选 name=del 且已选中获得的元素对象数组 来得到选中的数量
        var length = 0;
        $("[name=del]:checked").each(function () {//遍历已选中的checked数组
            length++;
            checkData.push($(this).parent().parent().parent().parent().find("td").eq(2).text());
        });
        /*alert(checkData);*/
        $.post("/doc/myfile/deletelist_share",
            {
                checkData: checkData
            }, function () {
                window.location = "/doc/myfile/share_list";
            })
    }
</script>
</body>
</html>
